name: Release Drafter

on:
  push:
    # branches to consider in the event; optional, defaults to all
    branches:
      - master
  # pull_request event is required only for autolabeler
  pull_request:
    # Only following types are handled by the action, but one can default to all as well
    types: [opened, reopened, synchronize]
  # pull_request_target event is required for autolabeler to support PRs from forks
  # pull_request_target:
  #   types: [opened, reopened, synchronize]

permissions:
  contents: read

jobs:
          
  update_release_draft:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.release-drafter.outputs.upload_url }}
      tag_name: ${{ steps.release-drafter.outputs.tag_name }}
    steps:
      - uses: release-drafter/release-drafter@v5
        id: release-drafter
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: release build ${{ matrix.target }}
    permissions:
      contents: write
    runs-on: ${{ matrix.os }}
    needs: [update_release_draft]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - { os: ubuntu-latest  , target: x86_64-unknown-linux-gnu       }
          - { os: ubuntu-latest  , target: x86_64-unknown-linux-musl      }
          - { os: ubuntu-latest  , target: armv7-unknown-linux-gnueabihf  }
          - { os: ubuntu-latest  , target: armv7-unknown-linux-musleabihf }
          - { os: ubuntu-latest  , target: aarch64-unknown-linux-gnu      }
          - { os: ubuntu-latest  , target: aarch64-unknown-linux-musl     }
          - { os: macos-latest   , target: x86_64-apple-darwin            }
          - { os: macos-latest   , target: aarch64-apple-darwin           }
          - { os: windows-latest , target: x86_64-pc-windows-msvc         }
          - { os: ubuntu-latest  , extension: ""     }
          - { os: macos-latest   , extension: ""     }
          - { os: windows-latest , extension: ".exe" }
          - { extension: ""    , archive: "tar", archive_extension: ".tar.gz" } 
          - { extension: ".exe", archive: "zip", archive_extension: ".zip"    } 

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # Rustのpackage名を取得して環境変数に入れておく。(後のステップで使用)
      - name: Extract crate information
        shell: bash
        run: |
          echo "PROJECT_NAME=$(sed -n 's/^name = "\(.*\)"/\1/p' Cargo.toml | head -n1)" >> $GITHUB_ENV

      - name: Set Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - uses: taiki-e/install-action@cross
      - uses: taiki-e/install-action@cargo-make

      - name: Build
        run: cargo make build --release --target ${{ matrix.target }}

      - name: rename binary
        shell: bash
        run: |
          mv target/${{ matrix.target }}/release/${{ env.project_name }}{,-${{ needs.update_release_draft.outputs.tag_name }}-${{ matrix.target }}${{ matrix.extension }}}

      - name: archive binary
        uses: thedoctor0/zip-release@0.7.5
        with:
          type: ${{ matrix.archive }}'
          directory: target/${{ matrix.target }}/release
          path: ${{ env.project_name }}-${{ needs.update_release_draft.outputs.tag_name }}-${{ matrix.target }}${{ matrix.extension }}
          filename: ${{ env.project_name }}-${{ needs.update_release_draft.outputs.tag_name }}-${{ matrix.target }}${{ matrix.archive_extension }}

      - name: upload release asset
        uses: actions/upload-release-asset@v1
        env:
          github_token: ${{ secrets.github_token }}
        with:
          upload_url: ${{ needs.update_release_draft.outputs.upload_url }}
          asset_path: target/${{ matrix.target }}/release/${{ env.project_name }}-${{ needs.update_release_draft.outputs.tag_name }}-${{ matrix.target }}${{ matrix.archive_extension }}
          asset_name: ${{ env.project_name }}-${{ needs.update_release_draft.outputs.tag_name }}-${{ matrix.target }}${{ matrix.archive_extension }}
          asset_content_type: application/octet-stream

